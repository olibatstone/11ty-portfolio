<script>
  window.addEventListener('DOMContentLoaded', function() {
    document.body.classList.add('fade-in');
  });
</script>
<!-- 100% privacy-first analytics -->
<script async src="https://scripts.simpleanalyticscdn.com/latest.js"></script>
<script async src="https://scripts.simpleanalyticscdn.com/auto-events.js"></script>

{% if layout == "layouts/selected-work.html" %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Scope to the "What I did" section
  const h2 = [...document.querySelectorAll('h2')]
    .find(h => h.textContent.trim() === 'What I did');
  if (!h2) return;

  // Collect siblings until the next H2
  const nodes = [];
  let n = h2.nextElementSibling;
  while (n && n.tagName !== 'H2') { nodes.push(n); n = n.nextElementSibling; }

  for (let i = 0; i < nodes.length; i++) {
    const node = nodes[i];
    if (!node || node.tagName !== 'H3') continue;

    const h3 = node;
    const anchorId = h3.id || null;

    // Build <details><summary>…</summary>…content…</details>
    const details = document.createElement('details');
    details.className = 'details-accordion';
    if (anchorId) { details.id = anchorId; }
    const summary = document.createElement('summary');
    summary.innerHTML = h3.innerHTML; // keep any inline markup in the H3
    details.appendChild(summary);

    // Move ALL following elements until next H3/H2 into the details
    let j = i + 1, moved = 0;
    while (j < nodes.length && !/^H[23]$/.test(nodes[j].tagName)) {
      details.appendChild(nodes[j]);
      nodes.splice(j, 1);
      moved++;
    }

    // Replace the H3 with the details block
    h3.replaceWith(details);
  }

  // Expand details when navigating to a hash target
  function expandDetailsForHash(hash) {
    const id = (hash || '').replace(/^#/,'');
    if (!id) return;
    const target = document.getElementById(id);
    if (target && target.tagName === 'DETAILS') {
      target.open = true;
      const sum = target.querySelector('summary');
      if (sum) { try { sum.focus({ preventScroll: true }); } catch(e) {} }
    }
  }

  // Initial load with hash
  expandDetailsForHash(decodeURIComponent(location.hash));

  // On hash changes
  window.addEventListener('hashchange', () => expandDetailsForHash(decodeURIComponent(location.hash)));

  // TOC clicks: open the corresponding details before scroll completes
  const tocLinks = document.querySelectorAll('.table-of-contents a[href^="#"]');
  tocLinks.forEach(a => {
    a.addEventListener('click', () => {
      const id = a.getAttribute('href').slice(1);
      const target = document.getElementById(id);
      if (target && target.tagName === 'DETAILS') {
        target.open = true;
      }
    });
  });
});
</script>
{% endif %}