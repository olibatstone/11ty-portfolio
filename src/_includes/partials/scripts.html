<script>
// Minimal emitter: call SA if ready; no buffering
window.sa_emit = function(){
  if (typeof window.sa_event === 'function') {
    return window.sa_event.apply(null, arguments);
  }
};
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.work-content') || document.querySelector('main');
  if (!container) return;

  const h3s = Array.from(container.querySelectorAll('h3'));
  h3s.forEach((h3, idx) => {
    if (!h3 || h3.closest('details.details-accordion')) return; // skip already processed

    // Build <details><summary>…</summary>…content…</details>
    const details = document.createElement('details');
    details.className = 'details-accordion';
    if (h3.id) details.id = h3.id;
    const summary = document.createElement('summary');
    summary.innerHTML = h3.innerHTML; // preserve inline markup
    details.appendChild(summary);

    // Move following siblings until next H3/H2
    let n = h3.nextElementSibling;
    let moved = 0;
    while (n && !/^H[23]$/.test(n.tagName)) {
      const next = n.nextElementSibling;
      details.appendChild(n);
      n = next;
      moved++;
    }

    // Only replace if there was body content to move
    if (!moved) return;

    // Emit readmore events on toggle for this details
    details.addEventListener('toggle', () => {
      const d = details;
      const all = Array.from((document.querySelector('.work-content')||document).querySelectorAll('details.details-accordion'));
      const isLast = all.length ? all[all.length - 1] === d : false;
      const id = d.id || `details-${Math.max(1, all.indexOf(d) + 1)}`;
      const labelEl = d.querySelector('summary');
      const label = labelEl ? (labelEl.textContent || '').trim() : '';
      if (d.open) {
        if (typeof window.sa_event === 'function') { sa_event('readmore_open', { id, last: isLast, label, path: location.pathname }); }
      } else {
        if (typeof window.sa_event === 'function') { sa_event('readmore_close', { id, last: isLast, label, path: location.pathname }); }
      }
    }, { passive: true });

    // Swap H3 for details block
    h3.replaceWith(details);
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.work-content') || document;
  container.querySelectorAll('details.details-accordion').forEach((details, idx) => {
    // skip if already has a toggle listener marker
    if (details.__hasReadmoreListener) return;
    details.__hasReadmoreListener = true;
    details.addEventListener('toggle', () => {
      const d = details;
      const all = Array.from(container.querySelectorAll('details.details-accordion'));
      const isLast = all.length ? all[all.length - 1] === d : false;
      const id = d.id || `details-${Math.max(1, all.indexOf(d) + 1)}`;
      const labelEl = d.querySelector('summary');
      const label = labelEl ? (labelEl.textContent || '').trim() : '';
      if (d.open) {
        if (typeof window.sa_event === 'function') { sa_event('readmore_open', { id, last: isLast, label, path: location.pathname }); }
      } else {
        if (typeof window.sa_event === 'function') { sa_event('readmore_close', { id, last: isLast, label, path: location.pathname }); }
      }
    }, { passive: true });
  });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Emit readmore events from <details class="details-accordion"> state changes
  document.addEventListener('toggle', (e) => {
    if (e.target === document) return; // safety
    const d = e.target;
    if (!(d instanceof HTMLDetailsElement)) return;
    if (!d.classList || !d.classList.contains('details-accordion')) return;

    const all = Array.from(document.querySelectorAll('details.details-accordion'));
    const isLast = all.length ? all[all.length - 1] === d : false;
    const id = d.id || `details-${Math.max(1, all.indexOf(d) + 1)}`;
    const labelEl = d.querySelector('summary');
    const label = labelEl ? (labelEl.textContent || '').trim() : '';

    if (d.open) {
      if (typeof window.sa_event === 'function') { sa_event('readmore_open', { id, last: isLast, label, path: location.pathname }); }
    } else {
      if (typeof window.sa_event === 'function') { sa_event('readmore_close', { id, last: isLast, label, path: location.pathname }); }
    }
  }, { capture: true, passive: true });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const container = document.querySelector('.work-content') || document.querySelector('main') || document.body;
  const selector = container.classList && container.classList.contains('work-content') ? '.work-content' : (container.tagName ? container.tagName.toLowerCase() : 'body');

  function getThresholds() {
    const rect = container.getBoundingClientRect();
    const start = window.scrollY + rect.top; // top of container in document coords
    const total = container.scrollHeight - window.innerHeight; // scrollable within container relative to viewport
    const maxY = start + Math.max(total, 0);
    return {
      p25: start + total * 0.25,
      p50: start + total * 0.50,
      p75: start + total * 0.75,
      p100: maxY
    };
  }

  let sent = { p25: false, p50: false, p75: false, p100: false };
  let ticking = false;
  let thresholds = getThresholds();

  function check(y) {
    if (!sent.p25 && y >= thresholds.p25) { if (typeof window.sa_event === 'function') { sa_event('scroll_25', { container: selector, path: location.pathname }); } sent.p25 = true; }
    if (!sent.p50 && y >= thresholds.p50) { if (typeof window.sa_event === 'function') { sa_event('scroll_50', { container: selector, path: location.pathname }); } sent.p50 = true; }
    if (!sent.p75 && y >= thresholds.p75) { if (typeof window.sa_event === 'function') { sa_event('scroll_75', { container: selector, path: location.pathname }); } sent.p75 = true; }
    if (!sent.p100 && y + 2 >= thresholds.p100) { if (typeof window.sa_event === 'function') { sa_event('scroll_100', { container: selector, path: location.pathname }); } sent.p100 = true; }
    if (y + 2 >= thresholds.p100) { if (typeof window.sa_event === 'function') { sa_event('case_study_scrolled_100', { path: location.pathname }); } }
  }

  function onScrollOrResize() {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        thresholds = getThresholds();
        check(window.scrollY);
        ticking = false;
      });
    }
  }

  window.addEventListener('scroll', onScrollOrResize, { passive: true });
  window.addEventListener('resize', onScrollOrResize, { passive: true });

  // Initial check
  check(window.scrollY);
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const btn = document.querySelector('.back-to-top');
  if (!btn) return;

  btn.addEventListener('click', () => {
    if (typeof window.sa_event === 'function') { sa_event('back_to_top', { path: location.pathname }); }
  }, { passive: true });
});
</script>
<script>
document.addEventListener('DOMContentLoaded', () => {
  const links = Array.from(document.querySelectorAll('a[href]')).filter(a => {
    const href = a.getAttribute('href');
    if (!href || href.startsWith('#')) return false;
    let url;
    try { url = new URL(href, location.origin); } catch (_) { return false; }
    if (url.origin !== location.origin) return false; // external
    const isCaseStudy = /\b(selected-work|work)\b/.test(url.pathname);
    return isCaseStudy && url.pathname !== location.pathname;
  });

  links.forEach(a => {
    a.addEventListener('click', () => {
      const url = new URL(a.getAttribute('href'), location.origin);
      if (typeof window.sa_event === 'function') { sa_event('case_study_next', { from: location.pathname, to: url.pathname }); }
    }, { passive: true });
  });
});
</script>